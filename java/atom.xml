<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://shanjiancaofu.com/java</id>
    <title>山间草夫的小站 Blog</title>
    <updated>2022-04-16T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://shanjiancaofu.com/java"/>
    <subtitle>山间草夫的小站 Blog</subtitle>
    <icon>https://shanjiancaofu.com/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[google guice 框架源码学习]]></title>
        <id>google-guice-source</id>
        <link href="https://shanjiancaofu.com/java/google-guice-source"/>
        <updated>2022-04-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[1. Google Guice 框架简介]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="1-google-guice-框架简介">1. Google Guice 框架简介<a class="hash-link" href="#1-google-guice-框架简介" title="Direct link to heading">​</a></h2><blockquote><p>​	本文有大量的截图和解释， 不妨用idea边调试边看文章。 </p></blockquote><p>​	在学习 <code>Spring</code> 的时候， 我们常常习惯用 <code>@Bean</code> 将Bean的创建交给spirng 来管理， 使用 <code>@Autowire</code> 实现依赖自动注入Bean。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyBean{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public Person person {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     return new Person();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ABCService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Person Person;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>​		在Spring 的项目中可以随便使用， 在没有Spring 的项目使用 DI 和IOC ，要引入 <code>spring-core</code> , 显得不是那么友好，一些不想用spring 框架的公司就会造出一些轮子，比如Google 公司出了一款轻量的IOC 框架， 下面我们来研究研究。</p><p>本文源码将会使用 google juice 的第一个版本版本号为：<code>66b415a2066cac9f36ed58070777de388f63a3a4 </code>，这个版本大约在20个类左右，基于jdk 1.5的，这个版本代码相对来说非常少。  下面我们带着目的去研究代码。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="2-如何bean创建和管理">2. 如何Bean创建和管理<a class="hash-link" href="#2-如何bean创建和管理" title="Direct link to heading">​</a></h2><p>下面是guice框架将Bar接口和实现类BarImpl绑定的代码，并且获取Bar类型的实例对象。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  public void testManageBean(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContainerBuilder builder = new ContainerBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.factory(Bar.class, BarImpl.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container container = builder.create(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bar instance = container.getInstance(Bar.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(instance);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>​	    首先创建了一个容器Builder， 再将Bar 和BarImpl 放入factory 方法中， 再调用create() 创建出容器， 最后通过getInstance() 方法来获取实例。下面看框架代码是如何实现的。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1--创建containerbuilder">1.  创建ContainerBuilder<a class="hash-link" href="#1--创建containerbuilder" title="Direct link to heading">​</a></h3><p><code>ContainerBuilder builder = new ContainerBuilder();</code></p><p>首先看看注释</p><div class="codeBlockContainer_I0IT language-english theme-code-block"><div class="codeBlockContent_wNvx english"><pre tabindex="0" class="prism-code language-english codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Builds a dependency injection {@link Container}. The combination of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> dependency type and name uniquely identifies a dependency mapping; you can</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use the same name for two different types. Not safe for concurrent use.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>构建一个依赖注入， 依赖的类型和唯一的名字作为映射，两个不同的类型可以使用同一个名字（好像spring 不可以这样）， 这个类并发不安全。</p><p>这里说一下ContainerBuilder 里面的三个变量， 后面会用到。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  final Map&lt;Key&lt;?&gt;, InternalFactory&lt;?&gt;&gt; factories =   new HashMap&lt;Key&lt;?&gt;, InternalFactory&lt;?&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final List&lt;InternalFactory&lt;?&gt;&gt; singletonFactories = new ArrayList&lt;InternalFactory&lt;?&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final List&lt;Class&lt;?&gt;&gt; staticInjections = new ArrayList&lt;Class&lt;?&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  boolean created;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol><li>factories             接口类型和实例工厂的映射</li><li>singletonFactories    单例bean的工厂， 所有生命周期是单例的都会加入这个集合</li><li>staticInjections  需要静态注入的Class 类集合</li><li>created               表示该容器是否已经创建，因为容器是是非线程安全，所以用这个字段标记一下</li></ol><p>下面开启idea debug 模式走起。</p><ol><li><p>builder.factory(Bar.class, BarImpl.class);</p><p><img alt="image-20220416135734557" src="/assets/images/image-20220416135734557-a8603f88b6a3b4df5a57b5b82c203523.png" width="519" height="160"></p><ol><li>​																				图1</li></ol></li></ol><p><img alt="image-20220416135800301" src="/assets/images/image-20220416135800301-ff1beae098f05d172336842e4587ec95.png" width="622" height="271"></p><p>​																										图2</p><p><img alt="image-20220416135815906" src="/assets/images/image-20220416135815906-d6031973bdaadb15738008745097cc5b.png" width="691" height="187"></p><p>​																										图3</p><p>从代码发现了方法再次重载， 同时给容器设置了一个默认的名字。 下面再进factory() 方法里面看</p><p><img alt="image-20220416140009260" src="/assets/images/image-20220416140009260-3e98542731f7544e9f2689d64362329b.png" width="1081" height="635"></p><p>​																								图4</p><p>201行的代码生成了一个工厂类， 这个工厂类通过构造器创建一个实例。同时实现类放到了implementation  字段里面了。 再继续debug</p><p><img alt="image-20220416140517464" src="/assets/images/image-20220416140517464-52ea682564c80056cc09af84ed975889.png" width="736" height="542"></p><p>​																					图5</p><p>第92 行把key和对应的生命周期工厂类放入了一个被封装后的工厂，这里为什么会用scope 来封装一下呢？ 主要是因为不同的生命周期有不同的创建方式。 比如单例只需要创建一次即可。从下图的代码的47行中可以看到Singleton 的 scopeFactory  方法加了锁， 这是保证单例安全。</p><p><img alt="image-20220416140847252" src="/assets/images/image-20220416140847252-5bf495580dd16f62f196f6c4d524bb06.png" width="1080" height="469"></p><p>​																							图6</p><p>默认工厂，直接返回工厂就行。</p><p><img alt="image-20220416140923405" src="/assets/images/image-20220416140923405-34d1b5451651b12539590b5f5cc6004a.png" width="766" height="193"></p><p>​																						图7</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-创建容器">2. 创建容器<a class="hash-link" href="#2-创建容器" title="Direct link to heading">​</a></h3><p><code>builder.create(false)</code></p><p><img alt="image-20220416142457081" src="/assets/images/image-20220416142457081-f9d5dcafdf6a5175183a3ef193f114e2.png" width="844" height="458"></p><p>​																									图8</p><ol><li>ensureNotCreated 因为Builder不是线程安全的，所以先确保不会被创建。将factoryies  放入ContainerImpl 里面， 因为loadSingletons是false， 同时我们也没有静态字段(这两行代码先不关注，后面会说）。所以直接将容器返回。</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="3获取实例">3.	获取实例<a class="hash-link" href="#3获取实例" title="Direct link to heading">​</a></h3><p><code>Bar instance = container.getInstance(Bar.class);</code></p><p><img alt="image-20220416143220942" src="/assets/images/image-20220416143220942-78b941a282a49a7b18490ac8347ae393.png" width="802" height="850"></p><p>​																			图9</p><p>​						callable.call(reference<!-- -->[0]<!-- -->) 回调了487行的getInstance(type, context)， 再继续深入</p><p>​			<img alt="image-20220416143523366" src="/assets/images/image-20220416143523366-cd391b7ddfbec393971b8454d831eebc.png" width="912" height="500"></p><p>​																						图10</p><p>447 行代码使用Bar的Class类型和名字创建了个Key类型实例， 通过key对象去factories 对象里面拿到对应的工厂类， 再创建Bar实现的实例。 毫无疑问下面又会调用创建实例的create方法。</p><p><img alt="image-20220416143746681" src="/assets/images/image-20220416143746681-f5c2536580446dfd74767d8d2008c6ca.png" width="1361" height="404"></p><p>​																					图11</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4--小结">4.  小结<a class="hash-link" href="#4--小结" title="Direct link to heading">​</a></h3><p>​		guice将接口的类型，名字等生成一个key， 然后生成该接口实现类的工厂类， 同时将Key和工厂类实例放入map里面， 再将map放入容器类里面。当Containner.getInsance() 获取实例的时候， 首先通过接口类型和名字生成key， 去Map 里面去找到对应的实现类的工厂类， 再调用create 方法生成对应的实现类。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-依赖注入如何实现">3. 依赖注入如何实现<a class="hash-link" href="#3-依赖注入如何实现" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">   public void testInjection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container container = createFooContainer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Foo foo = container.inject(Foo.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class Foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject Bar bar;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject Bar copy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject("s") String s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject("i")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setI(int i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.i = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Container createFooContainer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContainerBuilder builder = new ContainerBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .factory(Bar.class, BarImpl.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .factory(Tee.class, TeeImpl.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 指定字段s,i 注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .constant("s", "test")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .constant("i", 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return builder.create(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>名字叫Foo的类里面的bar 和copy 和s， 还有字段i， 都是使用了@Inject 注解的， 说明这些字段都是需要注入的。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1首先创建对象">1.	首先创建对象<a class="hash-link" href="#1首先创建对象" title="Direct link to heading">​</a></h3><ol><li><p>Foo foo = container.inject(Foo.class);</p><p><img alt="image-20220416145409582" src="/assets/images/image-20220416145409582-6539ee11d5fd87128d7488a10fddf06d.png" width="553" height="217"></p><p>​																						图12</p></li></ol><p><img alt="image-20220416145540216" src="/assets/images/image-20220416145540216-4b555a60a75d70b291bb97b6477ba58a.png" width="627" height="401"></p><p>​																								图13</p><p><img alt="image-20220416150031356" src="/assets/images/image-20220416150031356-7f7deaed1909e263e76d93f5e338dff2.png" width="807" height="219"></p><p>​																				图14</p><p>我们发现， 最后其实在调用472行中inject 方法。 继续debug 看看inject 方法到底在干什么。</p><p><img alt="image-20220416150225452" src="/assets/images/image-20220416150225452-3face804fcda338b5d7c2416f349427e.png" width="837" height="295"></p><p>​													图15</p><p>getConstructor(implementation) ， 拿到构造器调用construct 创建对象。 继续向下面看</p><p><img alt="image-20220416150619122" src="/assets/images/image-20220416150619122-02f1b39ed003d2a32c67c110fcfbb50d.png" width="964" height="818"></p><p>​																								图16(请忽略图里说的创建代理对象，这是创建构造器对象)</p><p>为Foo创建对象，并且将创建对象设置到代理中（这里代理用不上，后面在解决循环依赖的时候会说），并且拿到了该类的注入器对象injectors (在373行）， 这个注入器对象从哪儿来的？ 为什么我们debug 没有出来？ 这里其实在</p><p>图15的433 行代码中的  <code>ConstructorInjector constructor = getConstructor(implementation); </code>  ， 调用父类的异步方法去获取注入器。 框架里面有个类是 ReferenceCache， 用来做缓存的， 里面很多的异步操作。 但是今天我们不研究这个， 所以直接略过。</p><p><img alt="image-20220416151157660" src="/assets/images/image-20220416151157660-cc758dc8e12e3213a29478e49914e450.png" width="819" height="695"></p><p>​																							图17</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2注入字段">2.	注入字段<a class="hash-link" href="#2注入字段" title="Direct link to heading">​</a></h3><p>通过构造器的去拿到injects 对象集合, 刚好是4个， 回想一下Foo 里面的字段和静态方法也是4个。我们继续 debug <code> injector.inject(context, t)</code></p><p><img alt="image-20220416152821637" src="/assets/images/image-20220416152821637-5f79230262b70050b77e68ced0c0ef0e.png" width="671" height="479"></p><p>​																							图18</p><p>如图18 所示， 通过反射将字段注入进去。 这就是框架注入的步骤。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3小结">3.	小结<a class="hash-link" href="#3小结" title="Direct link to heading">​</a></h3><ol><li>创建代理对象</li><li>通过@Inject 获取注入器，使用反射注入对应的字段</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="4-处理依赖循环">4. 处理依赖循环<a class="hash-link" href="#4-处理依赖循环" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  @Scoped(SINGLETON)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class AImpl implements A {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final B b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject public AImpl(B b) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.b = b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public B getB() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  interface B {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A getA();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class BImpl implements B {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final A a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject public BImpl(A a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.a = a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public A getA() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="1先创建aimpl的构造器">1.	先创建AImpl的构造器<a class="hash-link" href="#1先创建aimpl的构造器" title="Direct link to heading">​</a></h4><p>AImpl 和 BImpl 相互依赖，并且AImpl是单例， 这种情况下， 框架是如何处理循环依赖的呢。</p><p><img alt="image-20220416155136101" src="/assets/images/image-20220416155136101-958b8f7cd0f3cec43e30fed071b6f168.png" width="1552" height="587"></p><p>​																		图19</p><p><img alt="image-20220416155237541" src="/assets/images/image-20220416155237541-b5435c44c72b355d9a0896668b9f4e29.png" width="1161" height="284"></p><p>​																				图20</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="2当发现自己的构造器参数里面有其它参数时先创建参数对象">2.	当发现自己的构造器参数里面有其它参数时，先创建参数对象<a class="hash-link" href="#2当发现自己的构造器参数里面有其它参数时先创建参数对象" title="Direct link to heading">​</a></h4><p>先Inject 参数B，相当于创建B</p><p><img alt="image-20220416155430941" src="/assets/images/image-20220416155430941-be102310320749c973712f5db41beb4a.png" width="1620" height="226"></p><p><img alt="image-20220416155548515" src="/assets/images/image-20220416155548515-df20c1aecfa29ad92ce68981dc0204e5.png" width="1553" height="890"></p><p><img alt="image-20220416155616081" src="/assets/images/image-20220416155616081-d5b75fa91df8107be933da29cc1043eb.png" width="1643" height="277"></p><p>​																									图21</p><p>进入B的参数构造器， 这个时候B的构造器参数里面需要AImpl的实例对象，</p><p><img alt="image-20220416155723093" src="/assets/images/image-20220416155723093-7f8bc7320e5560e8407d54d70aceb7de.png" width="1409" height="407"></p><p>​																					图22</p><p>​																		又去创建AImpl的单例对象。</p><p><img alt="image-20220416160838526" src="/assets/images/image-20220416160838526-9288d3737dae8afa2d2834b3996c86f5.png" width="1466" height="204"></p><p>​																						图23</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-参数对象创建完成后-再创建aimpl实例对象同时将持有aimpl的代理对象重新设置为新的aimpl的实例对象">3. 参数对象创建完成后, 再创建AImpl实例对象，同时将持有AImpl的代理对象重新设置为新的Aimpl的实例对象<a class="hash-link" href="#3-参数对象创建完成后-再创建aimpl实例对象同时将持有aimpl的代理对象重新设置为新的aimpl的实例对象" title="Direct link to heading">​</a></h4><p>判断A的构造器已经构造好了， 就会为B对象的AImpl创建代理对象。 就是下面的方法。 这个时候B持有的其实是AImpl的代理对象。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">if (constructionContext.isConstructing()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // TODO (crazybob): if we can't proxy this object, can we proxy the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // other object?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return constructionContext.createProxy(expectedType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>因为在第一次创建Aimpl的时候，已经 赋值了 this.constructing = true。 下次在创建的时候如果是在一个上下文中。下面的代码图21的357 调用的。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  void startConstruction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.constructing = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>现在B的Aimpl的代理对象创建好了，B的对象也创建好了。那么就要继续创建AImpl的实例对象。</p><p><img alt="image-20220416160217777" src="/assets/images/image-20220416160217777-a0cb8909d77f2bb119834a173393a4f8.png" width="1571" height="704"></p><p>​																						图24</p><p>创建完AImpl的对象之后， 再将AImpl的真实对象， B持有的InvocationHanlder.setDelegate(真实对象) 即可。 是不是很妙 ？  哎， 不得不佩服大神在2006 年就能写出这种代码， 太厉害啦。  guice框架里面解决依赖循环的是 ConstructionContext 这个类。大家有时间可以看看怎么解决的。 无论AImpl里面有多少个持有A对象实例的字段， 只要AImpl完成实例对象初始化后， 再设置给持有AImpl对象的代理就可以了。</p><p>下面再看看ConstructionContext 的部分代码</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Object createProxy(Class&lt;? super T&gt; expectedType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO: if I create a proxy which implements all the interfaces of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the implementation type, I'll be able to get away with one proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // instance (as opposed to one per caller).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!expectedType.isInterface()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new DependencyException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expectedType.getName() + " is not an interface.");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invocationHandlers == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      invocationHandlers = new ArrayList&lt;DelegatingInvocationHandler&lt;T&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DelegatingInvocationHandler&lt;T&gt; invocationHandler =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new DelegatingInvocationHandler&lt;T&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invocationHandlers.add(invocationHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Proxy.newProxyInstance(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expectedType.getClassLoader(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new Class[] { expectedType },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      invocationHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void setProxyDelegates(T delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invocationHandlers != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DelegatingInvocationHandler&lt;T&gt; invocationHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          : invocationHandlers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invocationHandler.setDelegate(delegate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><p>createProxy</p><p>创建代理对象， 当创建B对象的时候，在创建构造器的时候会先创建AImpl对象 ， 但是AImpl实例构造器已经被标记， 那就创建一个代理对象。</p></li><li><p>setProxyDelegates</p><p>当B的对象创建完成后，又返回到AImpl创建构造器对象代码的地方，继续创建AImpl对象的实例， 再调用setProxyDelegates 方法，给B持有的Aimpl的代理对象中的delegate设置为AImpl的实例。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="4-小结">4. 小结<a class="hash-link" href="#4-小结" title="Direct link to heading">​</a></h4><p>在两个A，B 两个对象相互依赖的时候， 首先创建A的构造器，标记一下A的构造器已经创建，当发现自己的构造器有参数B的时候先去常见构造器参数B，如果构造器中参数B， 创建实例对象B的时候发现需要创建A对象，这个时候A的构造器已经标记创建了， 那么就给B设置一个代理对象。当B创建完成后， 再创建A的实例对象， 同时再将A的实例对象设置给B的持有的A类型的代理对象。 这个主要是通过proxy 去实现的。 </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="5-静态注入">5. 静态注入<a class="hash-link" href="#5-静态注入" title="Direct link to heading">​</a></h2><p>  现在我们来看看静态注入是如何实现的。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">public class StaticInjectionTest extends TestCase {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void testInjectStatics() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container c = new ContainerBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .constant("s", "test")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .constant("i", 5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .injectStatics(StaticInjectionTest.Static.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .create(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assertEquals("test", StaticInjectionTest.Static.s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assertEquals(5, StaticInjectionTest.Static.i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class Static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject("i") static int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static String s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject("s") static void setS(String s) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      StaticInjectionTest.Static.s = s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol><li><p>直接看 <code>injectStatics</code> 方法调用，首先将需要注入的静态类设置加入集合。</p><p>injectStatics(StaticInjectionTest.Static.class)</p><p><img alt="image-20220416163728265" src="/assets/images/image-20220416163728265-a1e4081b543b1adb34bf1055d334ccd0.png" width="798" height="170"></p></li><li><p>在图5的时候， 我们已经知道在创建容器时会执行静态注入。如下图所示</p></li></ol><p><img alt="image-20220416163912290" src="/assets/images/image-20220416163912290-0033ab33d5870b7ad2c9930b5a6c6426.png" width="993" height="412"></p><p>​		我们继续看执行静态注入的具体流程， 继续debug  <code>container.injectStatics(staticInjections)</code></p><p><img alt="image-20220416164023068" src="/assets/images/image-20220416164023068-eca0ed16528a2336b7dc928fb78167b2.png" width="723" height="434"></p><p>​											下面继续看addInjectorsForMembers 方法做了什么？</p><p><img alt="image-20220416164306372" src="/assets/images/image-20220416164306372-2923cf857da924a2ec50cf229bd5dbe0.png" width="1010" height="398"></p><p>主要是这一段代码，<code>						injectors.add(injectorFactory.create(this, member, inject.value()));</code></p><p>过滤静态字段(inject.value() 是字段的名字，), injector 工厂生成了injector。这里的静态方法同理，所以不截图了。</p><p><img alt="image-20220416165057283" src="/assets/images/image-20220416165057283-295d2cb483e9cdbe9434488634a6103b.png" width="849" height="456"></p><p>​					拿到了注入器后，分别执行MethodInject和FieldInject的inject 方法，下面就不用细说了，背后的原理就是使用反射的方式给字段设置值， 调用静态方法设置值。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="6-guice-和spring-使用di-和ioc-速度对比">6. guice 和spring 使用DI 和IOC 速度对比<a class="hash-link" href="#6-guice-和spring-使用di-和ioc-速度对比" title="Direct link to heading">​</a></h2><p>在java 的生态中有一道永远迈不过的天花板，那就是spring。 所以guice 想和spring 一较高下。 guice 处理bean的速度大约是spring的40倍。这个测试类的名字是  <code>com.google.inject.SpringTest</code>  所有小伙伴们在使用storm 或者flink 之类的框架的时候，该选择guice 就要选择juice 。 </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="7-总结">7. 总结<a class="hash-link" href="#7-总结" title="Direct link to heading">​</a></h2><p>通过本篇文章我们能够学习到</p><ul><li>bean 的创建和管理（IOC)</li><li>依赖注入（DI）是如何实现的</li><li>如何处理依赖循环</li><li>静态注入如何实现</li></ul><p>​			本篇文章只是分析了部分功能的原理，这只是我们学习的一小步，我将在下一篇文章继续深入guice 框架的设计相关的内容， 学习完框架的设计相关的内容， 还会一步一步的手写一个实现简单功能的注入框架。</p>]]></content>
        <author>
            <name>jeesk</name>
            <uri>https://shanjiancaofu.com</uri>
        </author>
        <category label="java" term="java"/>
        <category label="DI" term="DI"/>
        <category label="IOC" term="IOC"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[java 源码分析]]></title>
        <id>/java 源码分析</id>
        <link href="https://shanjiancaofu.com/java/java 源码分析"/>
        <updated>2022-03-28T07:38:53.892Z</updated>
        <summary type="html"><![CDATA[Java 核心篇]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="java-核心篇">Java 核心篇<a class="hash-link" href="#java-核心篇" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-注解-annotation">1. 注解 annotation<a class="hash-link" href="#1-注解-annotation" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-工具instrument">2. 工具instrument<a class="hash-link" href="#2-工具instrument" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-调用invoke">3. 调用invoke<a class="hash-link" href="#3-调用invoke" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-管理-management">4. 管理 management<a class="hash-link" href="#4-管理-management" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-引用-ref">5. 引用 ref<a class="hash-link" href="#5-引用-ref" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="6">6.<a class="hash-link" href="#6" title="Direct link to heading">​</a></h3>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Elasticsearch 在竞价广告中的检索使用]]></title>
        <id>elasticsearch-user-rtb-ad</id>
        <link href="https://shanjiancaofu.com/java/elasticsearch-user-rtb-ad"/>
        <updated>2022-02-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Elasticsearch 在竞价广告中的检索使用]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="elasticsearch-在竞价广告中的检索使用">Elasticsearch 在竞价广告中的检索使用<a class="hash-link" href="#elasticsearch-在竞价广告中的检索使用" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="一广告定向简述">一、广告定向简述<a class="hash-link" href="#一广告定向简述" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="11-在竞价广告中的定向条件往往如下所示">1.1 在竞价广告中的定向条件往往如下所示<a class="hash-link" href="#11-在竞价广告中的定向条件往往如下所示" title="Direct link to heading">​</a></h4><ul><li>ad1  定向为地域北京,上海,广州,深圳,18~28岁的旅游,健身行业男性,并且要求适用的操作系统为ios,android,广告出价5块</li><li>ad2  定向为地域成都在18~28岁的健身行业男性,并且要求适用的操作系统为ios和mac,广告出价4.8块</li><li>ad3  定向为在28~38岁的男性,并且要求适用的操作系统为android,广告出价5.7块</li><li>ad4  定向为在28~38岁,并且要求适用的操作系统为ios,广告出价5.2块</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="12--角色对应广告分析">1.2  角色对应广告分析<a class="hash-link" href="#12--角色对应广告分析" title="Direct link to heading">​</a></h4><ul><li>角色1:     北京,女性,健身行业,操作系统ios</li><li>角色2:     广州,男性,18~28岁,旅游行业,操作系统为ios</li><li>角色3:     成都,女性,28~38岁,健身行业,操作系统为ios</li><li>角色4:     成都,男性,28~38岁,健身行业,操作系统为ios</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="13--认真分析后得出下面每个角色可以推送的广告如下">1.3.  认真分析后得出下面每个角色可以推送的广告如下<a class="hash-link" href="#13--认真分析后得出下面每个角色可以推送的广告如下" title="Direct link to heading">​</a></h4><ul><li>角色1:  ad4</li><li>角色2:  ad1,ad4</li><li>角色3:  ad4</li><li>角色4:  ad2,ad4</li></ul><p>往往传统数据库无法满足上述的查询时延, 大厂往往又开发自己的倒排索引系统, 为了减少成本, 可以使用elasticsearch的布尔查询.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="二使用elasticsearch-查询实时查询广告">二、使用elasticsearch 查询实时查询广告<a class="hash-link" href="#二使用elasticsearch-查询实时查询广告" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="21---mysql中-如果要查询某个用户满足的广告条件如下可整理为表达式">2.1.   mysql中, 如果要查询某个用户满足的广告条件如下可整理为表达式<a class="hash-link" href="#21---mysql中-如果要查询某个用户满足的广告条件如下可整理为表达式" title="Direct link to heading">​</a></h4><p>[（不存在性别定向）|| （存在性别定向且满足条件）]<br>
<!-- -->&amp;&amp;  <!-- -->[（不存在年龄定向）|| （存在年龄定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在标签定向）|| （存在标签定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在地域定向）|| （存在地域定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在操作系统定向）|| （存在操作系统定向且满足条件）]</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="22--准备工具--postman-或者支持curl命令行-一台安装了docker的机器">2.2  准备工具:  postman 或者支持curl命令行, 一台安装了docker的机器<a class="hash-link" href="#22--准备工具--postman-或者支持curl命令行-一台安装了docker的机器" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="221拉取es镜像并且运行起来">2.2.1	拉取es镜像,并且运行起来<a class="hash-link" href="#221拉取es镜像并且运行起来" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">docker pull docker.io/elasticsearch:7.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name es1  -e </span><span class="token assign-left variable" style="color:#36acaa">ES_JAVA_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"-Xms512m -Xmx512m"</span><span class="token plain"> -p </span><span class="token number" style="color:#36acaa">9200</span><span class="token plain">:9200 -p </span><span class="token number" style="color:#36acaa">9300</span><span class="token plain">:9300 -e </span><span class="token string" style="color:#e3116c">"discovery.type=single-node"</span><span class="token plain"> b0e9f9f047e6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="222----执行命令">2.2.2    执行命令<a class="hash-link" href="#222----执行命令" title="Direct link to heading">​</a></h5><p>postman或者命令行中执行 <code>curl --location --request GET 'http://192.168.17.77:9200'</code></p><p>如果返回下面的文档说明你安装单机版本的elasticsearch已经安装完成</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cc51cc2a79ce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"cluster_name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"docker-cluster"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"cluster_uuid"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BveCHkuVTtWwr-rcWDmTpg"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"number"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7.1.1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_flavor"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"default"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"docker"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_hash"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7a013de"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_date"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2019-05-23T14:04:00.380842Z"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_snapshot"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"lucene_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"8.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"minimum_wire_compatibility_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"6.8.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"minimum_index_compatibility_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"6.0.0-beta1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"tagline"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"You Know, for Search"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="23--建立广告索引查询广告位对应广告">2.3.  建立广告索引,查询广告位对应广告<a class="hash-link" href="#23--建立广告索引查询广告位对应广告" title="Direct link to heading">​</a></h4><p>通常用户访问app拉取广告是以广告位为基准, 该广告位下面有n个带有定向条件的广告.那么 查询条件就是广告位id,底价+以及用户自身的属性</p><p>创建广告位id为100的索引</p><p><code>curl --location --request PUT 'http://192.168.17.77:9200/posfor100'</code></p><ol><li>增加该索引对应的数据(类型于mysql的行数据)</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">北上广深,成都分别映射为 1,2,3,4,5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">男女映射为1,2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">操作系统ios, android,mac 映射为1,2,3  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">行业旅游,健身分别映射为 1,2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">年龄18~28 映射为2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>插入对应的4条数据,假设上面4个广告对应的id为 101,102,103,104</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/101' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/102' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4.8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/103' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5.7</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/104' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5.2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol><li>假设该广告位100的底价为3块钱,使用布尔查询</li></ol><p>角色1 对应的查询</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --location --request GET </span><span class="token string" style="color:#e3116c">'http://192.168.17.77:9200/posfor100/_search'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header </span><span class="token string" style="color:#e3116c">'Content-Type: application/json'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw </span><span class="token string" style="color:#e3116c">'{"query":{"bool":{"filter":[{"bool":{"should":[{"term":{"gender":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"gender","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"os":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"os","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"city":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"city","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"industry":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"industry","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"ageRange":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"ageRange","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"filter":[{"range":{"price":{"from":3.0,"to":null,"include_lower":true,"include_upper":true,"boost":1.0}}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}}'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>得到查询条件如下, 获得了id 104的广告,即是广告4</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"took"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">403</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"timed_out"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"_shards"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"successful"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"skipped"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"failed"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"relation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eq"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"max_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>角色2对应的查询</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --location --request GET </span><span class="token string" style="color:#e3116c">'http://192.168.17.77:9200/posfor100/_search'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header </span><span class="token string" style="color:#e3116c">'Content-Type: application/json'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw </span><span class="token string" style="color:#e3116c">'{"query":{"bool":{"filter":[{"bool":{"should":[{"term":{"gender":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"gender","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"os":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"os","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"city":{"value":4,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"city","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"industry":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"industry","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"ageRange":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"ageRange","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"filter":[{"range":{"price":{"from":3.0,"to":null,"include_lower":true,"include_upper":true,"boost":1.0}}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}}'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>得到的结果</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"took"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"timed_out"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"_shards"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"successful"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"skipped"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"failed"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"relation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eq"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"max_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>由上可得角色1获取到ad4,角色2获取到ad1,ad4, 和我们最初得到的结论是一样的2,  剩余角色3,角色4对应的广告,请各位亲自己动手验证.  </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="三小结">三、小结<a class="hash-link" href="#三小结" title="Direct link to heading">​</a></h3><ol><li>学习到定向条件可以通过es的布尔表达式来检索</li></ol><p>参考如下</p><ol><li><a href="https://zhuanlan.zhihu.com/p/59658727" target="_blank" rel="noopener noreferrer">基于布尔表达式的广告索引设计</a></li><li><a href="https://www.knowledgedict.com/tutorial/elasticsearch-aggregations.html" target="_blank" rel="noopener noreferrer">Elasticsearch（Es）聚合查询（指标聚合、桶聚合）</a></li></ol>]]></content>
        <author>
            <name>jeesk</name>
            <uri>https://shanjiancaofu.com</uri>
        </author>
        <category label="elasticsearch" term="elasticsearch"/>
        <category label="rtb-ad" term="rtb-ad"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Java BiO和NIO的区别]]></title>
        <id>java-bio-diffrent-from-nio</id>
        <link href="https://shanjiancaofu.com/java/java-bio-diffrent-from-nio"/>
        <updated>2022-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[NIO和BIO的区别总结]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="nio和bio的区别总结">NIO和BIO的区别总结<a class="hash-link" href="#nio和bio的区别总结" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-表格说明两者的区别">1. 表格说明两者的区别<a class="hash-link" href="#1-表格说明两者的区别" title="Direct link to heading">​</a></h3><table><thead><tr><th>IO类型</th><th>是否阻塞</th><th>同步IO</th><th>线程模型</th></tr></thead><tbody><tr><td>BIO</td><td>阻塞</td><td>是</td><td>一个线程对应一个请求</td></tr><tr><td>NIO</td><td>非阻塞</td><td>是</td><td>一个线程可以处理多个请求</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-示意图说明区别">2. 示意图说明区别<a class="hash-link" href="#2-示意图说明区别" title="Direct link to heading">​</a></h3><p><img src="/assets/images/image-20220124015657528-f47cdaaea50619bdc7ebb14063281585.png" width="769" height="511"></p><p><img alt="image-20220124015747188" src="/assets/images/image-20220124015747188-b8b97155e2470da02db7f9305dec70f1.png" width="962" height="819"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="代码实战">代码实战<a class="hash-link" href="#代码实战" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-bio实战">1. BIO实战<a class="hash-link" href="#1-bio实战" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="11-编写bio代码">1.1 编写BIO代码<a class="hash-link" href="#11-编写bio代码" title="Direct link to heading">​</a></h4><blockquote><p>​	目的:  实现一个server, 接受客户端发送来的消息, 并将消息返回给客户端</p><p>​    思路:</p><ol><li>首先创建一个ServerSocket , 并且绑定一个本地端口9999,</li><li> 等待客户端连接, 然后将连接交给线程池处理</li><li> 从inputStream 里面读取内容, 并且将内容使用outPutStream返回给客户端</li></ol></blockquote><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.InputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.OutputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.ServerSocket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.Socket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.ExecutorService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.Executors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BioServerTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 固定10个线程,并且创建给一个serverSocket,并且绑定端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService executorService = Executors.newFixedThreadPool(10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket serverSocket = new ServerSocket();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocket.bind(new InetSocketAddress(9999));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 接受客户端的请求, 并将客户端发送来的文字, 返回给客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 等待其它客户端的请求, 记住这里阻塞的,  当我们启动该程序, 这里的accept 会阻塞不动, 直到成功接收一个请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Socket accept = serverSocket.accept();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println("接受到请求");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将请求交给线程池处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executorService.submit(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    InputStream inputStream = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    OutputStream outputStream = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 不同连接的hashcode , 说明是来自不同的客户端的请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    int clientHashCode = accept.hashCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputStream = accept.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        outputStream = accept.getOutputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        byte[] bytes = new byte[1024];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int index = inputStream.read(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String s = new String(bytes, 0, index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("客户端:" + clientHashCode + ",发送来的消息是:" + s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        outputStream.write(("server回复: " + s).getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            accept.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="12-启动程序">1.2 启动程序<a class="hash-link" href="#12-启动程序" title="Direct link to heading">​</a></h4><p><img alt="image-20220124023401519" src="/assets/images/image-20220124023401519-5ff04acacb038b22dbf18519b32c9ef0.png" width="983" height="675"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="13在命令行中连接客户端-观察结果">1.3	在命令行中连接客户端, 观察结果<a class="hash-link" href="#13在命令行中连接客户端-观察结果" title="Direct link to heading">​</a></h4><p><img alt="image-20220124023544496" src="/assets/images/image-20220124023544496-5c1849770a9f7daabea7ce5317eb885c.png" width="1123" height="158"></p><p>输入hello world ,期待结果返回hello world</p><p><img alt="image-20220124023633274" src="/assets/images/image-20220124023633274-889331361f9f4993d239fc87de272902.png" width="1015" height="241"></p><p>idea 服务端的console 如下</p><p><img alt="image-20220124023653403" src="/assets/images/image-20220124023653403-c8ba7d7154bd76f5c5b416bde6440c6c.png" width="1127" height="227"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-nio实战">2. NIO实战<a class="hash-link" href="#2-nio实战" title="Direct link to heading">​</a></h3><h4></h4><blockquote><p>​	目的:  通过NIO 实现client和server的交互</p><p>​    思路:</p><p>​    Server 端思路</p><ol><li><p>首先创建socketServerChannel,和Selctor, 将channel 注册selector 上面去</p></li><li><p>等待客户端连接, 将客户端连接的channel注册到selctor上面去, 注意不同的channel有不同的事件</p></li><li><p>获取获取客户端channel拿到数据</p></li></ol><p>​    Client 端思路</p><ol><li>创建SocketChannel, 然后连接Server端</li><li>当连接完成后, 向Server端发送消息</li></ol></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="21-编写nio代码">2.1 编写NIO代码<a class="hash-link" href="#21-编写nio代码" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="221-server端代码">2.2.1 Server端代码<a class="hash-link" href="#221-server端代码" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.ByteBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SelectionKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.Selector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.ServerSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NIOServerDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Selector selector = Selector.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.bind(new InetSocketAddress(9999));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将serverSocketChannel的可接受事件注册到selector上面,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int resultCode = selector.select(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (resultCode == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println("服务器等待吧1s, 无连接");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (iterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SelectionKey selectionKey = iterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 当前事件是否可接受</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (selectionKey.isAcceptable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("client 连接成功" + serverSocketChannel.hashCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 拿到接受的socketChannel,将客户端channel的read事件注册到selector上面去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SocketChannel socketChannel = serverSocketChannel.accept();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        socketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 当前事件是否是可读事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (selectionKey.isReadable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 从channel拿到消息, 并且读取出来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SocketChannel channel = (SocketChannel) selectionKey.channel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ByteBuffer attachment = (ByteBuffer) selectionKey.attachment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        channel.read(attachment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("受到客户端信息:" + new String(attachment.array()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 最好别忘了移出key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    iterator.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="222-client端代码">2.2.2 Client端代码<a class="hash-link" href="#222-client端代码" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.ByteBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.charset.StandardCharsets;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * socket clilent 连接server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NIOClientDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建SocketChannel, 并且连接本地9999 端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SocketChannel socketChannel = SocketChannel.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InetSocketAddress inetSocketAddress = new InetSocketAddress("192.168.31.31", 9999);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        socketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!socketChannel.connect(inetSocketAddress)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!socketChannel.finishConnect()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println("连接需要时间");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println("连接server成功");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发server端发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String str = "hello world";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuffer wrap = ByteBuffer.wrap(str.getBytes(StandardCharsets.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int write = socketChannel.write(wrap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 挂起程序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="22启动程序">2.2	启动程序<a class="hash-link" href="#22启动程序" title="Direct link to heading">​</a></h4><p>启动Server</p><p><img alt="image-20220124071414769" src="/assets/images/image-20220124071414769-baf69d9866831e710fc9e38bbcd4ff98.png" width="991" height="437"></p><p>启动Client</p><p><img alt="image-20220124071513381" src="/assets/images/image-20220124071513381-7f817ef5d2d6d622cd480a3fe834cd27.png" width="969" height="281"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="23控制台观察结果">2.3	控制台观察结果<a class="hash-link" href="#23控制台观察结果" title="Direct link to heading">​</a></h5><p>期望Server端收到 Client 端的消息</p><p><img alt="image-20220124071559323" src="/assets/images/image-20220124071559323-b81850f464e2293a8d00302727fe0705.png" width="2019" height="451"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><ol><li>通过编写BIO 和NIO的代码可以得出, BIO是每个线程处理一个请求, 但是NIO可以一个线程处理多个请求.</li><li>NIO是通过将channel的事件注册到selector上面, 然后轮询事件,处理不同的事件.</li></ol><p>.</p>]]></content>
        <author>
            <name>jeesk</name>
            <uri>https://shanjiancaofu.com</uri>
        </author>
        <category label="java" term="java"/>
        <category label="io" term="io"/>
    </entry>
</feed>