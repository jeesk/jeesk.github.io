<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>山间草夫的小站 Blog</title>
        <link>https://shanjiancaofu.com/java</link>
        <description>山间草夫的小站 Blog</description>
        <lastBuildDate>Sat, 05 Feb 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[Elasticsearch 在竞价广告中的检索使用]]></title>
            <link>https://shanjiancaofu.com/java/elasticsearch-user-rtb-ad</link>
            <guid>elasticsearch-user-rtb-ad</guid>
            <pubDate>Sat, 05 Feb 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Elasticsearch 在竞价广告中的检索使用]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="elasticsearch-在竞价广告中的检索使用">Elasticsearch 在竞价广告中的检索使用<a class="hash-link" href="#elasticsearch-在竞价广告中的检索使用" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="一广告定向简述">一、广告定向简述<a class="hash-link" href="#一广告定向简述" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="11-在竞价广告中的定向条件往往如下所示">1.1 在竞价广告中的定向条件往往如下所示<a class="hash-link" href="#11-在竞价广告中的定向条件往往如下所示" title="Direct link to heading">​</a></h4><ul><li>ad1  定向为地域北京,上海,广州,深圳,18~28岁的旅游,健身行业男性,并且要求适用的操作系统为ios,android,广告出价5块</li><li>ad2  定向为地域成都在18~28岁的健身行业男性,并且要求适用的操作系统为ios和mac,广告出价4.8块</li><li>ad3  定向为在28~38岁的男性,并且要求适用的操作系统为android,广告出价5.7块</li><li>ad4  定向为在28~38岁,并且要求适用的操作系统为ios,广告出价5.2块</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="12--角色对应广告分析">1.2  角色对应广告分析<a class="hash-link" href="#12--角色对应广告分析" title="Direct link to heading">​</a></h4><ul><li>角色1:     北京,女性,健身行业,操作系统ios</li><li>角色2:     广州,男性,18~28岁,旅游行业,操作系统为ios</li><li>角色3:     成都,女性,28~38岁,健身行业,操作系统为ios</li><li>角色4:     成都,男性,28~38岁,健身行业,操作系统为ios</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="13--认真分析后得出下面每个角色可以推送的广告如下">1.3.  认真分析后得出下面每个角色可以推送的广告如下<a class="hash-link" href="#13--认真分析后得出下面每个角色可以推送的广告如下" title="Direct link to heading">​</a></h4><ul><li>角色1:  ad4</li><li>角色2:  ad1,ad4</li><li>角色3:  ad4</li><li>角色4:  ad2,ad4</li></ul><p>往往传统数据库无法满足上述的查询时延, 大厂往往又开发自己的倒排索引系统, 为了减少成本, 可以使用elasticsearch的布尔查询.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="二使用elasticsearch-查询实时查询广告">二、使用elasticsearch 查询实时查询广告<a class="hash-link" href="#二使用elasticsearch-查询实时查询广告" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="21---mysql中-如果要查询某个用户满足的广告条件如下可整理为表达式">2.1.   mysql中, 如果要查询某个用户满足的广告条件如下可整理为表达式<a class="hash-link" href="#21---mysql中-如果要查询某个用户满足的广告条件如下可整理为表达式" title="Direct link to heading">​</a></h4><p>[（不存在性别定向）|| （存在性别定向且满足条件）]<br>
<!-- -->&amp;&amp;  <!-- -->[（不存在年龄定向）|| （存在年龄定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在标签定向）|| （存在标签定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在地域定向）|| （存在地域定向且满足条件）]<!-- -->
&amp;&amp;  <!-- -->[（不存在操作系统定向）|| （存在操作系统定向且满足条件）]</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="22--准备工具--postman-或者支持curl命令行-一台安装了docker的机器">2.2  准备工具:  postman 或者支持curl命令行, 一台安装了docker的机器<a class="hash-link" href="#22--准备工具--postman-或者支持curl命令行-一台安装了docker的机器" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="221拉取es镜像并且运行起来">2.2.1	拉取es镜像,并且运行起来<a class="hash-link" href="#221拉取es镜像并且运行起来" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">docker pull docker.io/elasticsearch:7.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name es1  -e </span><span class="token assign-left variable" style="color:#36acaa">ES_JAVA_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"-Xms512m -Xmx512m"</span><span class="token plain"> -p </span><span class="token number" style="color:#36acaa">9200</span><span class="token plain">:9200 -p </span><span class="token number" style="color:#36acaa">9300</span><span class="token plain">:9300 -e </span><span class="token string" style="color:#e3116c">"discovery.type=single-node"</span><span class="token plain"> b0e9f9f047e6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="222----执行命令">2.2.2    执行命令<a class="hash-link" href="#222----执行命令" title="Direct link to heading">​</a></h5><p>postman或者命令行中执行 <code>curl --location --request GET 'http://192.168.17.77:9200'</code></p><p>如果返回下面的文档说明你安装单机版本的elasticsearch已经安装完成</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cc51cc2a79ce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"cluster_name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"docker-cluster"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"cluster_uuid"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BveCHkuVTtWwr-rcWDmTpg"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"number"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7.1.1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_flavor"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"default"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"docker"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_hash"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7a013de"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_date"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2019-05-23T14:04:00.380842Z"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"build_snapshot"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"lucene_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"8.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"minimum_wire_compatibility_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"6.8.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"minimum_index_compatibility_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"6.0.0-beta1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"tagline"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"You Know, for Search"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="23--建立广告索引查询广告位对应广告">2.3.  建立广告索引,查询广告位对应广告<a class="hash-link" href="#23--建立广告索引查询广告位对应广告" title="Direct link to heading">​</a></h4><p>通常用户访问app拉取广告是以广告位为基准, 该广告位下面有n个带有定向条件的广告.那么 查询条件就是广告位id,底价+以及用户自身的属性</p><p>创建广告位id为100的索引</p><p><code>curl --location --request PUT 'http://192.168.17.77:9200/posfor100'</code></p><ol><li>增加该索引对应的数据(类型于mysql的行数据)</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">北上广深,成都分别映射为 1,2,3,4,5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">男女映射为1,2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">操作系统ios, android,mac 映射为1,2,3  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">行业旅游,健身分别映射为 1,2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">年龄18~28 映射为2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>插入对应的4条数据,假设上面4个广告对应的id为 101,102,103,104</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/101' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/102' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4.8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/103' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5.7</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl --location --request POST 'http</span><span class="token operator" style="color:#393A34">:</span><span class="token comment" style="color:#999988;font-style:italic">//192.168.17.77:9200/posfor100/_doc/104' \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header 'Content-Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> application/json' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5.2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol><li>假设该广告位100的底价为3块钱,使用布尔查询</li></ol><p>角色1 对应的查询</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --location --request GET </span><span class="token string" style="color:#e3116c">'http://192.168.17.77:9200/posfor100/_search'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header </span><span class="token string" style="color:#e3116c">'Content-Type: application/json'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw </span><span class="token string" style="color:#e3116c">'{"query":{"bool":{"filter":[{"bool":{"should":[{"term":{"gender":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"gender","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"os":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"os","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"city":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"city","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"industry":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"industry","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"ageRange":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"ageRange","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"filter":[{"range":{"price":{"from":3.0,"to":null,"include_lower":true,"include_upper":true,"boost":1.0}}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}}'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>得到查询条件如下, 获得了id 104的广告,即是广告4</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"took"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">403</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"timed_out"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"_shards"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"successful"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"skipped"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"failed"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"relation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eq"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"max_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>角色2对应的查询</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --location --request GET </span><span class="token string" style="color:#e3116c">'http://192.168.17.77:9200/posfor100/_search'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--header </span><span class="token string" style="color:#e3116c">'Content-Type: application/json'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw </span><span class="token string" style="color:#e3116c">'{"query":{"bool":{"filter":[{"bool":{"should":[{"term":{"gender":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"gender","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"os":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"os","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"city":{"value":4,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"city","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"industry":{"value":1,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"industry","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"should":[{"term":{"ageRange":{"value":2,"boost":1.0}}},{"bool":{"must_not":[{"exists":{"field":"ageRange","boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"minimum_should_match":"1","boost":1.0}},{"bool":{"filter":[{"range":{"price":{"from":3.0,"to":null,"include_lower":true,"include_upper":true,"boost":1.0}}}],"adjust_pure_negative":true,"boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}}}'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>得到的结果</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"took"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"timed_out"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"_shards"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"successful"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"skipped"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"failed"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"total"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"relation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eq"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"max_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"hits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"city"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"gender"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"industry"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"posfor100"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_doc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_score"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"_source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"ageRange"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"os"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"price"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>由上可得角色1获取到ad4,角色2获取到ad1,ad4, 和我们最初得到的结论是一样的2,  剩余角色3,角色4对应的广告,请各位亲自己动手验证.  </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="三小结">三、小结<a class="hash-link" href="#三小结" title="Direct link to heading">​</a></h3><ol><li>合理使用term和prefix搜索可以精准的找出复合定向条件的数据， 这对于大数据匹配来说相当好用。 </li></ol><p>参考如下</p><ol><li><a href="https://zhuanlan.zhihu.com/p/59658727" target="_blank" rel="noopener noreferrer">基于布尔表达式的广告索引设计</a></li><li><a href="https://www.knowledgedict.com/tutorial/elasticsearch-aggregations.html" target="_blank" rel="noopener noreferrer">Elasticsearch（Es）聚合查询（指标聚合、桶聚合）</a></li></ol>]]></content:encoded>
            <category>elasticsearch</category>
            <category>rtb-ad</category>
        </item>
        <item>
            <title><![CDATA[Java BiO和NIO的区别]]></title>
            <link>https://shanjiancaofu.com/java/java-bio-diffrent-from-nio</link>
            <guid>java-bio-diffrent-from-nio</guid>
            <pubDate>Sun, 23 Jan 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[NIO和BIO的区别总结]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="nio和bio的区别总结">NIO和BIO的区别总结<a class="hash-link" href="#nio和bio的区别总结" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-表格说明两者的区别">1. 表格说明两者的区别<a class="hash-link" href="#1-表格说明两者的区别" title="Direct link to heading">​</a></h3><table><thead><tr><th>IO类型</th><th>是否阻塞</th><th>同步IO</th><th>线程模型</th></tr></thead><tbody><tr><td>BIO</td><td>阻塞</td><td>是</td><td>一个线程对应一个请求</td></tr><tr><td>NIO</td><td>非阻塞</td><td>是</td><td>一个线程可以处理多个请求</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-示意图说明区别">2. 示意图说明区别<a class="hash-link" href="#2-示意图说明区别" title="Direct link to heading">​</a></h3><p><img src="/assets/images/image-20220124015657528-f47cdaaea50619bdc7ebb14063281585.png" width="769" height="511"></p><p><img alt="image-20220124015747188" src="/assets/images/image-20220124015747188-b8b97155e2470da02db7f9305dec70f1.png" width="962" height="819"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="代码实战">代码实战<a class="hash-link" href="#代码实战" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-bio实战">1. BIO实战<a class="hash-link" href="#1-bio实战" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="11-编写bio代码">1.1 编写BIO代码<a class="hash-link" href="#11-编写bio代码" title="Direct link to heading">​</a></h4><blockquote><p>​	目的:  实现一个server, 接受客户端发送来的消息, 并将消息返回给客户端</p><p>​    思路:</p><ol><li>首先创建一个ServerSocket , 并且绑定一个本地端口9999,</li><li> 等待客户端连接, 然后将连接交给线程池处理</li><li> 从inputStream 里面读取内容, 并且将内容使用outPutStream返回给客户端</li></ol></blockquote><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.InputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.OutputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.ServerSocket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.Socket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.ExecutorService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.Executors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BioServerTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 固定10个线程,并且创建给一个serverSocket,并且绑定端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService executorService = Executors.newFixedThreadPool(14);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket serverSocket = new ServerSocket();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocket.bind(new InetSocketAddress(9999));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 接受客户端的请求, 并将客户端发送来的文字, 返回给客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 等待其它客户端的请求, 记住这里阻塞的,  当我们启动该程序, 这里的accept 会阻塞不动, 直到成功接收一个请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Socket accept = serverSocket.accept();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println("接受到请求");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将请求交给线程池处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executorService.submit(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    InputStream inputStream = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    OutputStream outputStream = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 不同连接的hashcode , 说明是来自不同的客户端的请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    int clientHashCode = accept.hashCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputStream = accept.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        outputStream = accept.getOutputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        byte[] bytes = new byte[1024];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int index = inputStream.read(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String s = new String(bytes, 0, index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("客户端:" + clientHashCode + ",发送来的消息是:" + s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        outputStream.write(("server回复: " + s).getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            accept.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="12-启动程序">1.2 启动程序<a class="hash-link" href="#12-启动程序" title="Direct link to heading">​</a></h4><p><img alt="image-20220124023401519" src="/assets/images/image-20220124023401519-5ff04acacb038b22dbf18519b32c9ef0.png" width="983" height="675"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="13在命令行中连接客户端-观察结果">1.3	在命令行中连接客户端, 观察结果<a class="hash-link" href="#13在命令行中连接客户端-观察结果" title="Direct link to heading">​</a></h4><p><img alt="image-20220124023544496" src="/assets/images/image-20220124023544496-5c1849770a9f7daabea7ce5317eb885c.png" width="1123" height="158"></p><p>输入hello world ,期待结果返回hello world</p><p><img alt="image-20220124023633274" src="/assets/images/image-20220124023633274-889331361f9f4993d239fc87de272902.png" width="1015" height="241"></p><p>idea 服务端的console 如下</p><p><img alt="image-20220124023653403" src="/assets/images/image-20220124023653403-c8ba7d7154bd76f5c5b416bde6440c6c.png" width="1127" height="227"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-nio实战">2. NIO实战<a class="hash-link" href="#2-nio实战" title="Direct link to heading">​</a></h3><h4></h4><blockquote><p>​	目的:  通过NIO 实现client和server的交互</p><p>​    思路:</p><p>​    Server 端思路</p><ol><li><p>首先创建socketServerChannel,和Selctor, 将channel 注册selector 上面去</p></li><li><p>等待客户端连接, 将客户端连接的channel注册到selctor上面去, 注意不同的channel有不同的事件</p></li><li><p>获取获取客户端channel拿到数据</p></li></ol><p>​    Client 端思路</p><ol><li>创建SocketChannel, 然后连接Server端</li><li>当连接完成后, 向Server端发送消息</li></ol></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="21-编写nio代码">2.1 编写NIO代码<a class="hash-link" href="#21-编写nio代码" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="221-server端代码">2.2.1 Server端代码<a class="hash-link" href="#221-server端代码" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.ByteBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SelectionKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.Selector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.ServerSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NIOServerDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Selector selector = Selector.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.bind(new InetSocketAddress(9999));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将serverSocketChannel的可接受事件注册到selector上面,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int resultCode = selector.select(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (resultCode == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println("服务器等待吧1s, 无连接");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (iterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SelectionKey selectionKey = iterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 当前事件是否可接受</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (selectionKey.isAcceptable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("client 连接成功" + serverSocketChannel.hashCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 拿到接受的socketChannel,将客户端channel的read事件注册到selector上面去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SocketChannel socketChannel = serverSocketChannel.accept();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        socketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 当前事件是否是可读事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (selectionKey.isReadable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 从channel拿到消息, 并且读取出来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SocketChannel channel = (SocketChannel) selectionKey.channel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ByteBuffer attachment = (ByteBuffer) selectionKey.attachment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        channel.read(attachment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println("受到客户端信息:" + new String(attachment.array()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 最好别忘了移出key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    iterator.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="222-client端代码">2.2.2 Client端代码<a class="hash-link" href="#222-client端代码" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.InetSocketAddress;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.ByteBuffer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.channels.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.charset.StandardCharsets;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * socket clilent 连接server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NIOClientDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建SocketChannel, 并且连接本地9999 端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SocketChannel socketChannel = SocketChannel.open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InetSocketAddress inetSocketAddress = new InetSocketAddress("192.168.31.31", 9999);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        socketChannel.configureBlocking(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!socketChannel.connect(inetSocketAddress)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!socketChannel.finishConnect()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println("连接需要时间");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println("连接server成功");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发server端发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String str = "hello world";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuffer wrap = ByteBuffer.wrap(str.getBytes(StandardCharsets.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int write = socketChannel.write(wrap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 挂起程序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="22启动程序">2.2	启动程序<a class="hash-link" href="#22启动程序" title="Direct link to heading">​</a></h4><p>启动Server</p><p><img alt="image-20220124071414769" src="/assets/images/image-20220124071414769-baf69d9866831e710fc9e38bbcd4ff98.png" width="991" height="437"></p><p>启动Client</p><p><img alt="image-20220124071513381" src="/assets/images/image-20220124071513381-7f817ef5d2d6d622cd480a3fe834cd27.png" width="969" height="281"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="23控制台观察结果">2.3	控制台观察结果<a class="hash-link" href="#23控制台观察结果" title="Direct link to heading">​</a></h5><p>期望Server端收到 Client 端的消息</p><p><img alt="image-20220124071559323" src="/assets/images/image-20220124071559323-b81850f464e2293a8d00302727fe0705.png" width="2019" height="451"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><ol><li>通过编写BIO 和NIO的代码可以得出, BIO是每个线程处理一个请求, 但是NIO可以一个线程处理多个请求。NIO是通过将selector的事件注册到channel上面, 然后轮询对应的key,处理不同的事件. 一个连接使用一个select线程就解决了。</li><li>在高并发的情况下面，1000个连接需要1000个线程才能连接。而BIO 一般情况下面使用 （2* cpu核）+2即可，这是因为NIO 是非阻塞的，不必等待
io阻塞，只有当写事件来的时候才会处理。显然NIO在使用少数线程的情况下对CPU时间片竞争较小，同时内存的占用也较小，随着社区的Wubflux的推进，在全异步的情况下面
Webflux能够充分利用多核CPU处理事件，提升并发量和吞吐量。在接口耗时固定IO时间固定的情况下，NIO虽然不能提升接口响应速度，但BIO的竞争相对来说更加激烈，接口耗时波动幅度很大，
NIO的处理时间相对来说更加平稳，并且吞吐量是远远优于BIO。这也是为什么社区越来越推荐Webflux的原因。也可以参考我先前做过的一次压力测试。</li></ol>]]></content:encoded>
            <category>java</category>
            <category>io</category>
        </item>
        <item>
            <title><![CDATA[Spring-boot 整合flink 教程]]></title>
            <link>https://shanjiancaofu.com/java/spring-boot-mercy-flink</link>
            <guid>spring-boot-mercy-flink</guid>
            <pubDate>Tue, 12 Jan 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[Flink框架：Flink整合springboot]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="flink框架flink整合springboot">Flink框架：Flink整合springboot<a class="hash-link" href="#flink框架flink整合springboot" title="Direct link to heading">​</a></h2><blockquote><p>首先说一下， 为什么flink 需要集成flink， spring boot给我们带来了更好的框架整合， 同时使用spring的DI和IOC，能更好的使用bean，当然直接使用spring 整合也是一样。后来我们使用了google guice 来整合。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-实现原理">1. 实现原理<a class="hash-link" href="#1-实现原理" title="Direct link to heading">​</a></h4><p>实现原理， spring 的启动 一般使用 <code>AnnotationConfigApplicationContext ac =  new AnnotationConfigApplicationContext(AppConfig.class);</code>   即可启动spring 容器， 对么spring boot 呢， 看过源码的人或许知道</p><p><code>SpringApplication.run(arge);</code>  只需要在启动flink之前启动sping boot 即可。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-代码实战">2. 代码实战<a class="hash-link" href="#2-代码实战" title="Direct link to heading">​</a></h4><blockquote><p>flink 整合spring boot 以及redission, 并将事件的id放入redis 中， 代码库  <a href="https://gitee.com/imomoda/flink-sprint-boot" target="_blank" rel="noopener noreferrer">https://gitee.com/imomoda/flink-sprint-boot</a></p></blockquote><h5 class="anchor anchorWithStickyNavbar_mojV" id="1spring-boot-启动工具类">1.	spring boot 启动工具类<a class="hash-link" href="#1spring-boot-启动工具类" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication(scanBasePackages = {"io.github.jeesk.flink"})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Import(SpringUtil.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties({RedissonProperties.class, RedisProperties.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringBootApplicationUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static SpringApplication springBootApplication = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static SpringApplicationBuilder springApplicationBuilder = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static synchronized void run(String[] arge) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (springBootApplication == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            StandardEnvironment standardEnvironment = new StandardEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MutablePropertySources propertySources = standardEnvironment.getPropertySources();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            propertySources.addFirst(new SimpleCommandLinePropertySource(arge));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String startJarPath = SpringBootApplicationUtil.class.getResource("/").getPath().split("!")[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] activeProfiles = standardEnvironment.getActiveProfiles();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            propertySources.addLast(new MapPropertySource("systemProperties", standardEnvironment.getSystemProperties()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            propertySources.addLast(new SystemEnvironmentPropertySource("systemEnvironment", standardEnvironment.getSystemEnvironment()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (springBootApplication == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                springApplicationBuilder = new SpringApplicationBuilder(SpringBootApplicationUtil.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 这里可以通过命令行传入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                springApplicationBuilder.profiles("dev");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                springApplicationBuilder.sources(SpringBootApplicationUtil.class).web(WebApplicationType.NONE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springBootApplication = springApplicationBuilder.build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springBootApplication.run(arge);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="2flink-job">2.	flink job<a class="hash-link" href="#2flink-job" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">package io.github.jeesk.flink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cn.hutool.extra.spring.SpringUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.github.jeesk.flink.config.SpringBootApplicationUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.KeyedProcessFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.util.Collector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.walkthrough.common.entity.Alert;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.walkthrough.common.entity.Transaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.walkthrough.common.sink.AlertSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.walkthrough.common.source.TransactionSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FraudDetectionJob {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = new Configuration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (args != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configuration.setString("args", String.join(" ", args));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringBootApplicationUtil.run(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;Transaction&gt; transactions = env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .addSource(new TransactionSource())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name("transactions");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;Alert&gt; alerts = transactions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .keyBy(Transaction::getAccountId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .process(new FraudDetector())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name("fraud-detector");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        alerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .addSink(new AlertSink())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name("send-alerts");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute("Fraud Detection");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static public class FraudDetector extends KeyedProcessFunction&lt;Long, Transaction, Alert&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private StringRedisTemplate redisTemplate = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void open(Configuration parameters) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 初始化bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super.open(parameters);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SpringBootApplicationUtil.run(parameters.getString("arge", "").split(" "));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisTemplate = SpringUtil.getBean(StringRedisTemplate.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void processElement(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Transaction transaction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Context context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collector&lt;Alert&gt; collector) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Alert alert = new Alert();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alert.setId(transaction.getAccountId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将id 放入redis 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisTemplate.opsForSet().add("tmpKey", String.valueOf(alert.getId()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            collector.collect(alert);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="3-flink-使用logback-还是log4j--本demo-使用的是logback--需要做以下的处理">3. flink 使用logback 还是log4j,  本demo 使用的是Logback , 需要做以下的处理<a class="hash-link" href="#3-flink-使用logback-还是log4j--本demo-使用的是logback--需要做以下的处理" title="Direct link to heading">​</a></h5><ol><li>服务器端处理:    flink 的安装目录下面放入logback 的包，<code>log4j-over-slf4j-1.7.15.jar,logback-classic-1.2.3.jar,logback-core-1.2.3.jar </code> ,</li><li>然后删除lib下面关于log4j的包 <code>log4j-1.2.17.jar及slf4j-log4j12-1.7.15.jar</code>), 如果不懂这些包的作用可以仔细阅读: <a href="https://www.jianshu.com/p/7d12a8c25a38" target="_blank" rel="noopener noreferrer">JAVA 常见日志依赖处理细节</a>  ，</li><li>在代码的pom文件里面排除log4j的包</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;artifactId&gt;flink-java&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;version&gt;1.13.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!--排除log4j--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;artifactId&gt;*&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;scope&gt;provided&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;flink-streaming-java_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.13.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;!--排除log4j--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;*&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &lt;scope&gt;provided&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;/dependency&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="4"><li>如果想修改flink 的logback的日志文件 ， 可以在flink的conf目录下面修改下面的三个文件</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">logback-console.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logback-session.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logback.xml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="3参考内容">3.参考内容<a class="hash-link" href="#3参考内容" title="Direct link to heading">​</a></h4><ul><li><p><a href="https://www.cnblogs.com/gouyg/p/storm-springboot.html" target="_blank" rel="noopener noreferrer">Storm框架：Storm整合springboot</a></p></li><li><p><a href="https://blog.csdn.net/qq_36643786/article/details/90401822" target="_blank" rel="noopener noreferrer">Flink使用logback须知</a></p></li></ul>]]></content:encoded>
            <category>java</category>
            <category>spring-boot</category>
            <category>flink</category>
        </item>
        <item>
            <title><![CDATA[JAVA 常见日志依赖处理细节]]></title>
            <link>https://shanjiancaofu.com/java/java-log-adapter-study</link>
            <guid>java-log-adapter-study</guid>
            <pubDate>Sun, 01 Nov 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[本文并不设置某个日志框架的配置,只是介绍其他日志框架和slf4j 的切换与桥接配合使用]]></description>
            <content:encoded><![CDATA[<h4 class="anchor anchorWithStickyNavbar_mojV" id="本文并不设置某个日志框架的配置只是介绍其他日志框架和slf4j-的切换与桥接配合使用">本文并不设置某个日志框架的配置,只是介绍其他日志框架和slf4j 的切换与桥接配合使用<a class="hash-link" href="#本文并不设置某个日志框架的配置只是介绍其他日志框架和slf4j-的切换与桥接配合使用" title="Direct link to heading">​</a></h4><blockquote><p> 当你的项目中有spring ,kafka, hbase , hadoop 等框架的时候, 日志依赖混乱,各种pom眼花缭乱, 看了下面的文字, 让你轻松掌握各种日志框架的混合使用和嫁接.</p></blockquote><h5 class="anchor anchorWithStickyNavbar_mojV" id="各种包介绍">各种包介绍<a class="hash-link" href="#各种包介绍" title="Direct link to heading">​</a></h5><ol><li><p>log4j</p><ul><li><code>log4j</code> : 实现和接口都在这个包</li></ul></li><li><p>log4j2</p><ul><li><p><code>log4j-core</code> : 核心包,日志实现</p></li><li><p><code>log4j-api</code> : 日志api</p></li></ul></li><li><p>logback</p><ul><li><p><code>logback-core</code> : logback 核心包</p></li><li><p><code>logback-classic</code> : 实现包,实现了slf4j-api</p></li></ul></li><li><p>commons-logging</p><ul><li><p><code>commons-logging</code> : jcl的原生全部内容</p></li><li><p><code>log4j-jcl</code> : jcl到log4j2的桥梁 , 使用jcl的实现, 但是使用log4j2的接口</p></li><li><p><code>jcl-over-slf4j</code> ：jcl到slf4j的桥梁,使用slf4j 的api, 日志打印 实现使用jcl</p></li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="日志框架包的分类">日志框架包的分类<a class="hash-link" href="#日志框架包的分类" title="Direct link to heading">​</a></h2><ol><li><p>api 包, 这种包只有接口, 比如slf4j-api, log4j-api ,每个日志框架都要自己api.</p></li><li><p>实现包, 比如slf4j-api 的实现有logback-classic, log4j-api的实现有log4j.</p></li><li><p>桥接器 日志统一管理使用slf4j, 但是实现用的jcl, 或者jul,或者log4j , 但是这些实现都不是slf4j的api的实现,只能提供桥接器,将slf4j 打印的日志, 交给具体的实现去操作, 这里的桥接器也可以叫做驱动.</p></li><li><p>切换器, 我需要将log4j 切换到Logback , 这个时候, 我可以使用slf4j提供的假包, 替换原有的实现类, 然后将日志重新交给slf4j管理. 比如, 项目使用的是Log4j, 那么直接使用 <code>log4j-over-slf4j</code> 替换log4j 即可. (其实在很多的文章中并没有切换器这个概念, 包括maven的分类中, 但是为了区分功能, 这里我还是区分出来了)</p></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="桥接器包">桥接器包<a class="hash-link" href="#桥接器包" title="Direct link to heading">​</a></h5><blockquote><p>什么是桥接器, 就是某个日志的具体实现, 要想配合slf4j的api使用, 但是在使用slf4j 的api的打印, 无法找到对应的实现类,  这个时候需要第三方包桥接一下, 当slf4j 打印日志的时候,交给具体的日志实现类.</p></blockquote><ol><li><p><code>slf4j-jdk14</code> ：slf4j到jdk-logging的桥梁</p></li><li><p><code>slf4j-log4j12</code> ：slf4j到log4j1的桥梁</p></li><li><p><code>log4j-slf4j-impl</code> ：slf4j到log4j2的桥梁</p></li><li><p><code>logback-classic</code> ：slf4j到logback的桥梁</p></li><li><p><code>slf4j-jcl</code> ：slf4j到commons-logging的桥梁</p></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="切换器包-偷天换日-slf4j-提供了其他日志的包-替换了原来的程序-直接将日志交给了slf4j管理-并且不需要更改代码-但是jul-除外">切换器包( 偷天换日, slf4j 提供了其他日志的包, 替换了原来的程序, 直接将日志交给了slf4j管理, 并且不需要更改代码. 但是jul 除外)<a class="hash-link" href="#切换器包-偷天换日-slf4j-提供了其他日志的包-替换了原来的程序-直接将日志交给了slf4j管理-并且不需要更改代码-但是jul-除外" title="Direct link to heading">​</a></h5><blockquote><p>什么是切换器, 就是当一个模块使用了他自己的日志实现和api , 但是想将日志的输出交给slf4j 管理. 这个时候需要一个切换器将第三方模块的日志切换到slf4j.</p></blockquote><ol><li><p><code>jul-to-slf4j</code> ：jdk-logging到slf4j的桥梁, 将jul 日志交给slf4j管理, 这个包不能和slf4j-jdk14 共存, 否则会导致无限循环.</p></li><li><p><code>jcl-over-slf4j</code> ：commons-logging到slf4j的桥梁,commons-logging.jar替换 为 jcl-over-slf4j.jar, 将jcl的日志交给slf4j管理.</p></li><li><p><code>slf4j-jcl.jar</code> : 我们的一些用户在切换到 SLF4J API 后意识到，在某些情况下，JCL 的使用是强制性的，他们使用 SLF4J 可能是一个问题。对于这种不常见但很重要的情况，SLF4J 提供了 JCL 绑定，可在文件slf4j-jcl.jar 中找到。JCL 绑定会将通过 SLF4J API 进行的所有日志记录调用委托给 JCL。因此，如果由于某种原因现有应用程序必须 使用 JCL，那么您的应用程序部分仍然可以以对更大的应用程序环境透明的方式针对 SLF4J API 进行编码。您选择的 SLF4J API 对可以继续使用 JCL 的应用程序的其余部分是不可见的。 这种情况下. jcl-overslf4j.jar-不可与slf4j-jcl.jar 同时使用.</p></li><li><p><code>log4j-over-slf4j</code> ：log4j1到slf4j的桥梁, 而只需将log4j.jar文件替换为 log4j-over-slf4j.jar.</p></li><li><p><code>log4j-to-slf4j</code> log4j2 到slf4j的桥梁, 将log4j2的日志移交给slf4j, 原文 <a href="https://logging.apache.org/log4j/2.x/log4j-to-slf4j/index.html" target="_blank" rel="noopener noreferrer">原文</a>.</p></li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="日志方案">日志方案:<a class="hash-link" href="#日志方案" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="直接使用api和实现">直接使用api和实现<a class="hash-link" href="#直接使用api和实现" title="Direct link to heading">​</a></h5><ol><li><p>直接使用java common log 模块: <code>use-jcl-log</code></p></li><li><p>直接使用log4j 的api和实现 模块: <code>use-log4j</code></p></li><li><p>直接使用log4j2 的api和实现 模块: <code>use-log4j2-impl-and-log4j2-api</code></p></li><li><p>直接使用jdk-logging 实现和api 模块: <code>use-jdk-logging</code></p></li><li><p>直接使用slf4j-api和slf4j-simple简单的日志实现 模块: <code>slf4j-sample-impl</code></p></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="使用slf4j自带">使用slf4j自带<a class="hash-link" href="#使用slf4j自带" title="Direct link to heading">​</a></h5><ol><li><p>使用slf4j的api,没有任何实现 模块: <code>nologImpl</code></p></li><li><p>使用slf4j的api, 并且同时使用slf4f-nop,和slf4j-sample 实现 模块: <code>multilogImpl</code></p></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="使用第三方实现-和slf4j-的api">使用第三方实现 和slf4j 的api<a class="hash-link" href="#使用第三方实现-和slf4j-的api" title="Direct link to heading">​</a></h5><ol><li><p>使用log4j 的实现,结合slf4j 的api 模块: <code>user-log4jImpl-and-slf4japi</code></p></li><li><p>使用jdk的实现,结合slf4j 的api 模块: <code>use-jdk-logging-imple-and-sl4j-api</code></p></li><li><p>使用 jcl 日志实现,结合slf4j的api 模块: <code>use-jcl-imple-and-slf4j-api</code></p></li><li><p>使用logback的日志实现,结合slf4j的api 模块: <code>use-logback-imple-and-slf4j-api</code></p></li><li><p>使用log4j2 的日志实现,结合slf4j 的api 模块: <code>use-log4j2-imple-and-slf4j-api</code></p></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="日志切换器引用的模块使用了自己的日志实现和api-将日志输出切换到slf4j-上面-项目中常用常见依赖处理">日志切换器,引用的模块使用了自己的日志实现和api, 将日志输出切换到slf4j 上面 (项目中常用,常见依赖处理)<a class="hash-link" href="#日志切换器引用的模块使用了自己的日志实现和api-将日志输出切换到slf4j-上面-项目中常用常见依赖处理" title="Direct link to heading">​</a></h5><ol><li><p>jcl 切换到 slf4j , 最终由logback 打印 模块: <code>remove-common-logging-use-slf4j</code></p></li><li><p>log4j 切换到 slf4j ,最终由logback 打印 模块: <code>remove-log4j-use-slf4j-and-use-logback-impl</code></p></li><li><p>jdk logging 切换到 slf4j,最终由logback 打印 模块: <code>remove-jdk-loggin-use-slf4j-and-logback-impl</code></p></li></ol><blockquote><p>由于作者水平有限, 出现的错误请多多包含. 烦请指点一二.</p></blockquote><p>本文简书地址: <a href="https://www.jianshu.com/p/7d12a8c25a38" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/7d12a8c25a38</a>
全文例子如下: <a href="https://gitee.com/imomoda/log4-study" target="_blank" rel="noopener noreferrer">https://gitee.com/imomoda/log4-study</a></p>]]></content:encoded>
            <category>java</category>
            <category>log</category>
        </item>
        <item>
            <title><![CDATA[kafka消息顺序保持一致性的处理方式]]></title>
            <link>https://shanjiancaofu.com/java/kafka-msg-keep-ordered</link>
            <guid>kafka-msg-keep-ordered</guid>
            <pubDate>Wed, 01 May 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[由于kafka 的分区是物理隔离，所有只有让分区保持顺序消费。在我们的广告业务中一般情况下是让某个广告位下面的数据保持分区一致性即可。]]></description>
            <content:encoded><![CDATA[<blockquote><p>由于kafka 的分区是物理隔离，所有只有让分区保持顺序消费。在我们的广告业务中一般情况下是让某个广告位下面的数据保持分区一致性即可。</p></blockquote><ol><li>指定partitionKey , 并且一个partition一个消费者线程</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kafkaProducer.send(new ProducerRecord&lt;&gt;("fad-service-show", 1,id + "", id + ""));</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>这里的第一个参数是topic, 第二个参数是partion.
上面的消息将会分发到  fad-service-show-1 的partition中去,
在kafka consumer 的</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 8; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                listTP.add(new TopicPartition("fad-service-show", i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.assign(listTP);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>上面的consumer 可以指定订阅consumer的partition.
2. broker 宕机后, partition的数量不会减少, 也不会影响partitionKey的sharding. 所以说, 如果说如果一个topic , n个partition, 使用顺序消费直接指定partition即可.</p>]]></content:encoded>
            <category>java</category>
            <category>DI</category>
            <category>IOC</category>
        </item>
        <item>
            <title><![CDATA[webflux,kakfa,redis,protostuff 吞吐量优化近4000QPS]]></title>
            <link>https://shanjiancaofu.com/java/webflux-vs-servlet3.0-pressure-test</link>
            <guid>webflux-vs-servlet3.0-pressure-test</guid>
            <pubDate>Mon, 04 Mar 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[__]]></description>
            <content:encoded><![CDATA[<p>__</p><ol><li>在虚拟机 8c32g  ,一个tomcat 实现400~500 的并发, 3000QPS 已经快是极限, 由于是阻塞式编程, 导致响应时长的的均值和最值差距相当的大.  通过webflux 可以增加并发量, 同时吞吐量有所改善.</li></ol><p>下面是通过jvm 调优后, 不同的web架构的压力测试图.
机器:  内网下 8c32g虚拟机 , 1台压测机器, 1台服务.  属于直连压测, 未经过网关.
下面是压测结果.
<img alt="img.png" src="/assets/images/img-9a42c4e1ae2b1142949c1ce32753ed07.png" width="1200" height="437"></p><ol><li>webflux 的吞吐量 高于传统servlet 的同步io,大约在 %10~15的效果</li><li>webflux  的耗时相对于传统servlet更加均匀</li><li>耗时改善不少.</li></ol><p>总体来说, 全异步的webflux 确实比传统的servlet  要优秀不少.</p><p>jvm 调优参数相关  使用g1垃圾垃圾回收,比较激进. 对于webflux 来说效果优化特别好.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">--server.port=8081 -Xms8g -Xmx8g -Xmn4g -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m -Xloggc:/dev/shm/mq_gc_%mxs.log</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div>]]></content:encoded>
            <category>java</category>
            <category>webflux</category>
            <category>servlet</category>
        </item>
        <item>
            <title><![CDATA[java 性能优化笔记]]></title>
            <link>https://shanjiancaofu.com/java/java-opt-note</link>
            <guid>java-opt-note</guid>
            <pubDate>Sun, 24 Feb 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[指标:]]></description>
            <content:encoded><![CDATA[<p>指标:</p><ol><li>性能指标: 吞吐量,响应速度</li><li>响应时间: 平均响应时间, 百分数</li><li>并发量</li><li>秒开率</li><li>正确性</li></ol><p>linux 系统
top - 1:
us: 用户的态所占百分比
sy: 系统态所占百分比
ni: 高优先级应用所占百分比
id: cpu 空闲百分比
hi: 硬中断百分比
si: 软中断百分比
st: 宿主机队虚拟机的影响
wa: io 等待磁盘,写入写出</p><p>load average:  表示1 分钟, 5 分钟 15 分钟的负载</p><p>vmstat :
vmstat  3  60 , 表示3秒刷新一次, 持续60秒
b 列读写磁盘
si/so:  交换分区对性能的影响
cs:  上下文切换</p><p>查看内存信息: /proc/meminfo
查看CPU信息: /proc/cpuinfo
jvm 预先分配内存: -XX:+AlwaysPreTouch
使用nmon 工具:  m加入内存,c加入cpu,n 加入网络,d加入磁盘</p><p>-Dcom.sun.management.jmxremote.port=14000
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false</p><p>性能的几个测试工具:
nmon : 系统性能
jconsole / visualVm : java 线程
jcmd : java 应用详细数据
arthas: 单个请求链的详情
wrk: 压力测试
2 个线程. 100 个连接   持续10 s
wrk -t2 -c10 -d10s <a href="http://qf.csmxwl.com/fund/index/dj" target="_blank" rel="noopener noreferrer">http://qf.csmxwl.com/fund/index/dj</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[root@ggpt06 wrk]# ./wrk -t2 -c20 -d3s http://qf.csmxwl.com/fund/index/dj   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running 3s test @ http://qf.csmxwl.com/fund/index/dj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2 threads and 20 connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Latency     1.32s   639.51ms   1.83s    75.00%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Req/Sec     1.00      0.82     2.00     42.86%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7 requests in 3.00s, 415.46KB read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Socket errors: connect 0, read 0, write 0, timeout 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests/sec:      2.33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer/sec:    138.37KB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>12 threads and 100 connections:
总共是12个线程,100个连接(不是一个线程对应一个连接)
latency和Req/Sec:
代表单个线程的统计数据,latency代表延迟时间,Req/Sec代表单个线程每秒完成的请求数，他们都具有平均值, 标准偏差, 最大值, 正负一个标准差占比。一般我们来说我们主要关注平均值和最大值. 标准差如果太大说明样本本身离散程度比较高. 有可能系统性能波动很大.
23725 requests in 30.05s, 347.47MB read
在30秒之内总共有23725个请求,总共读取347.47MB的数据
Socket errors: connect 0, read 48, write 0, timeout 50
总共有48个读错误,50个超时.
Requests/sec和Transfer/sec
所有线程平均每秒钟完成了789.57个请求,每秒钟读取11.56MB数据量</p><p>Guava :
weakValue,weakKey
当没有任何强引用，与 key 或者 value 有关系时，就删掉整个缓存项。这两个函数经常被误解。</p><ol><li>maxumumSize</li><li>initalCapacity</li></ol>]]></content:encoded>
            <category>java</category>
            <category>opt</category>
        </item>
        <item>
            <title><![CDATA[ThreadPoolExecutor参数详解和优化建议]]></title>
            <link>https://shanjiancaofu.com/java/java-threadpool-config-opt-adivse</link>
            <guid>java-threadpool-config-opt-adivse</guid>
            <pubDate>Sun, 03 Feb 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[按照上面参数顺序讲解]]></description>
            <content:encoded><![CDATA[<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            10,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            20,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TimeUnit.MINUTES,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new SynchronousQueue&lt;Runnable&gt;(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new ThreadFactory() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public Thread newThread(Runnable r) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new Thread();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new RejectedExecutionHandler() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>按照上面参数顺序讲解</p><ol><li>$\color{#FF0000}{corePoolSize 核心线程池数量 }$</li></ol><ul><li>创建线程池的时候没有线程, 当提交任务的时候会陆续创建线程, 当corePoolSize 满的时候, 会将任务放到队列中去, 队列满了, 那么会继续创建 corePoolIsze 到maxPoolSize之间的线程 .</li><li>设置allowCoreThreadTimeout=true（默认false）时，核心线程会超时关闭</li><li>prestartAllCoreThread  或者prestartAllCoreThread 初始化核心线程</li></ul><ol start="2"><li>$\color{#FF0000}{maxPoolSize最大线程池数量}$</li></ol><ul><li>当线程数量 = maxPoolSize , 且任务队列已经满了,  线程池会拒绝任务抛出一场</li><li>我们的项目 这个参数是 Runtime.getRuntime().availableProcessors() * 4 +1 , 根据压力测试获得最好的最大核心数量</li></ul><ol start="3"><li>$\color{#FF0000}{keepAliveTime  线程空闲时间}$</li></ol><ul><li>空闲的线程能够保持空闲的时间, 超过这个时间, 这一部分线程将被回收.</li><li>核心线程到最大线程数量的差异, 如果两个值相等, 那么这个参数毫无意义.</li></ul><ol start="4"><li>$\color{#FF0000}{BlockingQueue 阻塞队列}$</li></ol><ul><li>当核心线程数达到最大时，新任务会放在队列中排队等待执行</li><li>常见的队列<ol><li>ArrayBlockingQueue： 有界队列，基于数组结构，按照队列FIFO原则对元素排序；</li><li>LinkedBlockingQueue：无界队列，基于链表结构，按照队列FIFO原则对元素排序，Executors.newFixedThreadPool()使用了这个队列</li><li>SynchronousQueue 同步队列, 该队列不存储元素，每个插入操作必须等待另一个线程调用移除操作，否则插入操作会一直被阻塞，Executors.newCachedThreadPool()使用了这个队列；</li><li>PriorityBlockingQueue：优先级队列，具有优先级的无限阻塞队列。</li></ol></li></ul><p>6  .   $\color{#FF0000}{ThreadFactory 线程工厂}$</p><ul><li>自定义线程的名字,daemon,优先级等</li></ul><ol start="7"><li>$\color{#FF0000}{rejectedExecutionHandler 拒绝策略}$</li></ol><ul><li>这里的拒绝可以采取你自定义的办法, 比如使用second 线程池处理 r , 或者丢弃r, 或者打印出日志, 取决于你的业务.</li><li>线程池执行拒绝的两种情况<ol><li>当线程数量达到maxPoolSize , 队列已经满了, 会拒绝新任务</li><li>当线程池调用shutdown 的时候, 会等待线程池的任务执行完毕, 再shutdown, 这是一种优雅的方式.  调用shutdown和shutdown关闭之前, 这段时间会拒绝新任务. shutdownNow, 会立刻关闭, 并且停止执行任务. 和shutdown 有很大区别.</li></ol></li><li>几种拒绝策略<ol><li>AbortPolicy 丢弃任务, 抛运行异常(如果不设置, 默认就是这一个策略)</li><li>CallerRunsPolicy 执行任务</li><li>DiscardPolicy 忽视，什么都不会发生</li><li>DiscardOldestPolicy 从队列中踢出最先进入队列（最后一个执行）的任务</li></ol></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="线程执行的一些流程">线程执行的一些流程<a class="hash-link" href="#线程执行的一些流程" title="Direct link to heading">​</a></h4><ol><li>如果当前线程池中的线程数目 小于  &lt; corePoolSize 。则对于每个新任务，都会创建一个线程去执行这个任务(即使core线程中也有空闲线程, 也会新创建线程会执行)。</li><li>如果当前线程池中的线程数目 大于等于 &gt;= corePoolSize 。
对于每个新任务，会将其添加到任务队列中。若添加成功，则任务由空闲的线程主动将其从队列中移除后执行。若添加失败（任务队列已满），则尝试创建新的线程执行。</li><li>若当前线程池中的线程数目到达 maximumPoolSize ，则对于新任务采取拒绝策略。</li><li>如果线程池中的数量大于 corePoolSize 时，如果某个线程空闲时间超过 keepAliveTime ，线程会被终止，直到线程池中的线程数目不超过 corePoolSize 。</li><li>如果为核心线程池中的线程设置存活时间，则当核心线程池中的线程空闲时间超过 keepAliveTime ，则该线程也会被终止</li><li>如果核心线程数已经达到, 如果没有队列没有满的话, 是不会创建新的线程. 有时候取决你使用什么队列. 比如使用 ArrayBlockingQueue(10), 当核心线程已经创建完成, 只有当队列满了之后才会继续创建新的线程. 如果你使用的是SynchronousQueue, 内部只能一个的队列,那么只有队列直接创建core线程到maxpoolSize 之间的线程</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="线程池性能优化建议">线程池性能优化建议<a class="hash-link" href="#线程池性能优化建议" title="Direct link to heading">​</a></h4><ol><li>建议使用 prestartAllCoreThread  或者prestartAllCoreThread 初始化核心线程</li><li>考虑 allowCoreThreadTimeOut  允许核心线程能够回收节约机器的使用.</li><li>拒绝策略可以将任务, 提交给 second 线程池处理.</li><li>自定义ThreadFactory ,标识线程, 方便排查线程的使用情况</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="关于线程异常是否处理的问题">关于线程异常是否处理的问题:<a class="hash-link" href="#关于线程异常是否处理的问题" title="Direct link to heading">​</a></h4><ol><li>execute : 如果不手动捕获一场, 线程池只能重新创建新的异常来填补空白，重新创建线程这是有代价的</li><li>submit:   因为能够调用 future.get(). 所以有异常也会捕获, 不会造成线程终止.</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// 证明execute 的异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test1() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread.setDefaultUncaughtExceptionHandler((Thread t, Throwable e) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn("Exception in thread {}", t, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = "test";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService threadPool = Executors.newFixedThreadPool(1, new ThreadUtil.ThreadFactoryImpl(prefix));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IntStream.rangeClosed(1, 10).forEach(i -&gt; threadPool.execute(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i == 5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException("error");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info("I'm done : {}", i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(Thread.currentThread().getName() + " I'm done : " + i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt; 5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Assert.assertEquals(prefix + "1",  Thread.currentThread().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Assert.assertEquals(prefix + "2", Thread.currentThread().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threadPool.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threadPool.awaitTermination(1, TimeUnit.HOURS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 本来是通过test 1 线程执行的, 后面出现异常 确是test2 执行的, 说明x线程已经终止2, 并且重新创建线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// 线程名称没有变, 说明已经帮你捕获异常.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String prefix = "test";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService threadPool = Executors.newFixedThreadPool(1, new ThreadUtil.ThreadFactoryImpl(prefix));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Future&gt; futures = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IntStream.rangeClosed(1, 10).forEach(i -&gt; futures.add(threadPool.submit(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i == 5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException("error");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info("I'm done : {}", i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            if (i &lt; 5) Assert.assertEquals(prefix + "1", Thread.currentThread().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            else Assert.assertEquals(prefix + "2", Thread.currentThread().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Future future : futures) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                future.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn("future ExecutionException", e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threadPool.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threadPool.awaitTermination(1, TimeUnit.HOURS);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="面试问题">面试问题<a class="hash-link" href="#面试问题" title="Direct link to heading">​</a></h4><ol><li>说说线程池的核心参数有哪些</li><li>说说你们的corePoolSize  的数量是如何设置,超时时间如何设置</li><li>你们使用的是什么队列,  为什么使用这个队列.</li><li>你们项目是如何优化自己的线程池参数的.</li><li>当线程池还没达到 corePoolSize 的时候, 线程池里面有空闲线程, 这个时候来了一个新的任务, 线程池是创建新的线程还是使用空闲线程 ?</li></ol><blockquote><p> 路过点赞, 月入10w</p></blockquote>]]></content:encoded>
            <category>java</category>
            <category>log</category>
        </item>
        <item>
            <title><![CDATA[log4j打印日志的原理]]></title>
            <link>https://shanjiancaofu.com/java/log4j-print-log</link>
            <guid>log4j-print-log</guid>
            <pubDate>Sat, 01 Dec 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[log4j-slf4j-impl: log4j的日志转到slf4j上]]></description>
            <content:encoded><![CDATA[<p>log4j-slf4j-impl: log4j的日志转到slf4j上</p><p>LoggerFactory.getLogger () 方法 寻找对应的logger</p><p>org.slf4j.LoggerFactory#findPossibleStaticLoggerBinderPathSet
寻找staticLoggerBinder</p><p>paths = loggerFactoryClassLoader.getResources(STATIC_LOGGER_BINDER_PATH);
通过路径寻找所有的binder, 这里的STATIC_LOGGER_BINDER_PATH = org/slf4j/impl/StaticLoggerBinder.class, 每个slf4j的具体实现类都有一个StaticLoggerBinder.class</p><p>org.slf4j.LoggerFactory#reportMultipleBindingAmbiguity
判断是否有多个binder, 如果有将会打印日志: SLF4J: Class path contains multiple SLF4J bindings. SLF4J: Found binding in <!-- -->[jar:file:/Z:/repository/org/slf4j/slf4j-simple/1.7.28/slf4j-simple-1.7.28.jar!/org/slf4j/impl/StaticLoggerBinder.class]<!-- --> SLF4J: Found binding in <!-- -->[jar:file:/Z:/repository/org/slf4j/slf4j-nop/1.7.28/slf4j-nop-1.7.28.jar!/org/slf4j/impl/StaticLoggerBinder.class]<!-- --> SLF4J: See <a href="http://www.slf4j.org/codes.html#multiple_bindings" target="_blank" rel="noopener noreferrer">http://www.slf4j.org/codes.html#multiple_bindings</a> for an explanation.., 这个日志是我们常见的, 因为有多个日志实现</p><p>org/slf4j/impl/StaticLoggerBinder.class, 每个slf4j的日志实现都有这个类
找到所有绑定的logger</p><p>调用 StaticLoggerBinder.getSingleton();
这里如果有多个class, 应该是按顺序调用第一个class的getSingleton(),
调用 reportActualBinding
打印绑定的是哪一个日志实现
SLF4J: Actual binding is of type <!-- -->[org.slf4j.impl.SimpleLoggerFactory]<!-- -->
getILoggerFactory()
获得到刚才StaticLoggerBinder的日志工厂
SimpleLoggerFactory.getLogger
public Logger getLogger(String name) {
Logger simpleLogger = (Logger)this.loggerMap.get(name);
if (simpleLogger != null) {
return simpleLogger;
} else {
Logger newInstance = new SimpleLogger(name);
Logger oldInstance = (Logger)this.loggerMap.putIfAbsent(name, newInstance);
return (Logger)(oldInstance == null ? newInstance : oldInstance);
}
}
指定的logger 作缓存, 然后调用info() 方法打印日志.</p>]]></content:encoded>
            <category>java</category>
            <category>log</category>
        </item>
    </channel>
</rss>